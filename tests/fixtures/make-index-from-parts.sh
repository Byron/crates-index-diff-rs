#!/bin/bash

set -eu -o pipefail

parts="${1:?first argument is the repoitory root}/tests/fixtures/index-parts"
commit_list=$parts/commit.list

mkdir worktree
(cd worktree
  git init
  tar -x < $parts/init.*.tar
  git add . && git commit -m "initial commit"


  while read -r commit; do
      patch -p1 --remove-empty-files < "$parts/$commit.diff"
      git add .
      git commit -F "$parts/$commit.msg"
  done < "$commit_list"

  git checkout --orphan squashed
  git add .
  git commit -m "squashed"
  echo '{"name":"git-repository","vers":"1.0.0","deps":[{"name":"anyhow","req":"^1","features":[],"optional":false,"default_features":true,"target":null,"kind":"dev"},{"name":"async-std","req":"^1.12.0","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"byte-unit","req":"^4.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"clru","req":"^0.5.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"document-features","req":"^0.2.0","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-actor","req":"^0.11.4","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-attributes","req":"^0.3.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-config","req":"^0.7.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-credentials","req":"^0.4.0","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-date","req":"^0.1.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-diff","req":"^0.17.2","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-discover","req":"^0.4.1","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-features","req":"^0.22.2","features":["progress","once_cell"],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-glob","req":"^0.3.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-hash","req":"^0.9.8","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-index","req":"^0.4.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-lock","req":"^2.0.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-mailmap","req":"^0.3.2","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-object","req":"^0.20.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-odb","req":"^0.31.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-pack","req":"^0.21.2","features":["object-cache-dynamic"],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-path","req":"^0.4.1","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-protocol","req":"^0.19.0","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-ref","req":"^0.15.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-refspec","req":"^0.1.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-revision","req":"^0.4.3","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-sec","req":"^0.3.1","features":["thiserror"],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-tempfile","req":"^2.0.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-transport","req":"^0.19.2","features":[],"optional":true,"default_features":true,"target":null,"kind":"normal"},{"name":"git-traverse","req":"^0.16.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-url","req":"^0.7.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-validate","req":"^0.5.5","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"git-worktree","req":"^0.4.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"is_ci","req":"^1.1.1","features":[],"optional":false,"default_features":true,"target":null,"kind":"dev"},{"name":"log","req":"^0.4.14","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"regex","req":"^1.6.0","features":["std"],"optional":true,"default_features":false,"target":null,"kind":"normal"},{"name":"serde","req":"^1.0.114","features":["derive"],"optional":true,"default_features":false,"target":null,"kind":"normal"},{"name":"serial_test","req":"^0.8.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"dev"},{"name":"signal-hook","req":"^0.3.9","features":[],"optional":false,"default_features":false,"target":null,"kind":"normal"},{"name":"smallvec","req":"^1.9.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"tempfile","req":"^3.2.0","features":[],"optional":false,"default_features":true,"target":null,"kind":"dev"},{"name":"thiserror","req":"^1.0.26","features":[],"optional":false,"default_features":true,"target":null,"kind":"normal"},{"name":"unicode-normalization","req":"^0.1.19","features":[],"optional":false,"default_features":false,"target":"cfg(target_vendor = \"apple\")","kind":"normal"},{"name":"walkdir","req":"^2.3.2","features":[],"optional":false,"default_features":true,"target":null,"kind":"dev"}],"cksum":"13a607977b24ff29831297c80ae3b24bd45b04f81f3ca3047744453d6ae6e920","features":{"async-network-client":["git-protocol/async-client","unstable"],"async-network-client-async-std":["async-std","async-network-client","git-transport/async-std"],"blocking-http-transport":["git-transport/http-client-curl"],"blocking-network-client":["git-protocol/blocking-client","unstable"],"cache-efficiency-debug":["git-features/cache-efficiency-debug"],"default":["max-performance","one-stop-shop"],"fast-sha1":["git-features/fast-sha1"],"local":["git-diff"],"max-performance":["fast-sha1","max-performance-safe"],"max-performance-safe":["git-features/parallel","git-features/zlib-ng-compat","git-pack/pack-cache-lru-static","git-pack/pack-cache-lru-dynamic"],"one-stop-shop":["local"],"serde1":["serde","git-pack/serde1","git-object/serde1","git-protocol/serde1","git-transport/serde1","git-ref/serde1","git-odb/serde1","git-index/serde1","git-mailmap/serde1","git-attributes/serde1","git-revision/serde1"],"unstable":["git-mailmap","git-credentials"]},"yanked":false,"links":null}' >> gi/t-/git-repository
  git commit -am "celebration"
  git checkout main

  git gc
)

git clone --bare --no-local ./worktree base
rm -Rf worktree
git clone --bare base clone
